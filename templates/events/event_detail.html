{% set FACEBOOK_OBJECT = "event" %}

{% extends "base.html" %}

{% block facebook_properties %}
    <meta property="og:url"    content="{{ event.get_absolute_url() }}" /> 
    <meta property="og:title"  content="{{ event.title }}" /> 
    <meta property="og:title_yes"  content="{{ event.title_fb_yes }}" /> 
    <meta property="og:title_no"  content="{{ event.title_fb_no }}" /> 
    <meta property="og:image"  content="{{ event.small_image.url }}" /> 
{% endblock %}

{% block js_includes %}
    {{ super() }}
    <script src="http://cdn.pubnub.com/pubnub-3.4.min.js"></script>
{% endblock %}

{% block initial_data %}
    {{ super() }}

    initialData['bets'] = {{ bet_dicts | jsonify }};
    initialData['events'] = [{{ event_dict | jsonify }}];
{% endblock %}

{% block script_document_ready %}
    {{ super() }}

    {{ macros.pubnub_init() }}

    pubnub.subscribe({
        channel    : "{{ event.publish_channel }}",
        restore    : false,
        callback   : function(message) {
            ajaxResponseParser(message);
        },
    });
{% endblock %}

{% block content %}
    <h2 class="single-event-header">{{ event.title }}</h2>

    {% if event.big_image %}
        <img src="{{ event.big_image.url }}" width={{ config.BIG_EVENT_IMAGE_WIDTH }} height={{ config.BIG_EVENT_IMAGE_HEIGHT }} />         
    {% endif %}

    <p>TODO: chart</p>

    <article class="description" id="description">
        <p>{{ event.descrition }}</p>
    </article>

    {% if request.user.is_authenticated() %}

    <aside class="current-money well" id="current-money">
        <h4 class="tac">{% trans %}Currently you have{% endtrans%}: <br/> <span class="money" data-bind="flashText:userVM.total_cash"></span></h4>
    </aside>
    <table class="buy-sell" data-bind="with: eventsVM.firstEvent()">
        <tr>
            <td class="buy-for" style="display:none;" data-bind="visible: has_bets_for_NO() == 0">
                <p class="price-container">
                    {% trans %}Price{% endtrans %}:
                    <span id="buy_for_price" class="money" data-bind="flashText: buy_for_price"></span>
                </p>
                <button type="button" class="btn-success btn btn-large btn-primary" data-loading-text="{% trans %}Buying...{% endtrans %}" data-bind="bootstrapButtonLoading: loading_buy_YES, click: buy_YES">{% trans %}Buy for YES{% endtrans %}</button>
                <p class="bets-container">
                    {% trans %}You have{% endtrans %}:
                    <span id="has_bets_quantity" class="money" data-bind="flashText: has_bets_for_YES"></span>
                </p>
            </td>
            <td class="buy-against" style="display:none;" data-bind="visible: has_bets_for_YES() == 0">
                <p class="price-container">
                    {% trans %}Price{% endtrans %}:
                    <span id="buy_against_price" class="money" data-bind="flashText: buy_against_price"></span>
                </p>                
                <button type="button" class="btn-danger btn btn-large btn-primary" data-loading-text="{% trans %}Buying...{% endtrans %}" data-bind="bootstrapButtonLoading: loading_buy_NO, click: buy_NO">{% trans %}Buy for NO{% endtrans %}</button>
                <p class="bets-container">
                    {% trans %}You have{% endtrans %}:
                    <span id="has_bets_quantity" class="money" data-bind="flashText: has_bets_for_NO"></span>
                </p>
            </td>
            <td class="sell-for" style="display:none;" data-bind="visible: has_bets_for_YES() > 0">
                <p class="price-container">
                    {% trans %}Price{% endtrans %}:
                    <span id="sell_for_price" class="money" data-bind="flashText: sell_for_price"></span>
                </p>
                <button type="button" class="btn-success btn btn-large btn-primary" data-loading-text="{% trans %}Selling...{% endtrans %}" data-bind="bootstrapButtonLoading: loading_sell_YES, click: sell_YES">{% trans %}Sell for YES{% endtrans %}</button>
                <p class="bets-container">
                    {% trans %}You have{% endtrans %}:
                    <span id="has_bets_quantity" class="money" data-bind="flashText: has_bets_for_YES"></span>
                </p>                
            </td>
            <td class="sell-against" style="display:none;" data-bind="visible: has_bets_for_NO() > 0">
                <p class="price-container">
                {% trans %}Price{% endtrans %}: 
                    <span id="sell_against_price" class="money" data-bind="flashText: sell_against_price"></span>
                </p>
                <button type="button" class="btn-danger btn btn-large btn-primary" data-loading-text="{% trans %}Selling...{% endtrans %}" data-bind="bootstrapButtonLoading: loading_sell_NO, click: sell_NO">{% trans %}Sell for NO{% endtrans %}</button>
                <p class="bets-container">
                    {% trans %}You have{% endtrans %}:
                    <span id="has_bets_quantity" class="money" data-bind="flashText: has_bets_for_NO"></span>
                </p>
            </td>                 
        </tr>
    </table>

    {% endif %}

    <div id="ajax-results" class="animated-feedback-box">
    </div>

{% endblock %}